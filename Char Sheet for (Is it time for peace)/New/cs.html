<div class="nav">
    <input type="radio" name="attr_tab" class="tab tab1" value="1" title="Character" checked="checked" />
    <input type="radio" name="attr_tab" class="tab tab2" value="2" title="Health" />
    <input type="radio" name="attr_tab" class="tab tab3" value="3" title="Quirks" />
    <input type="radio" name="attr_tab" class="tab tab4" value="4" title="Skills" />
    <input type="radio" name="attr_tab" class="tab tab5" value="5" title="Inventory" />
    
    
    <div class="tab_content tab1 container">
        <div class="container border char">
            <div class="item container info">
                <div class="container info1 border">
                    <div class="Black Box item">NAME</div>
                    <input type="text" name="attr_character_name" class="textbox Name item L">
                    <div class="Black Box item">AGE</div>
                    <input type="number" name="attr_character_age" class="textbox Age item L">
                </div>
                <div class="container info2  border">
                    <div class="Black Box">RACE</div>
                    <input type="text" name="attr_character_race" class="textbox Race L">
                    <div class="Black Box">HEIGHT</div>
                    <input type="number" name="attr_character_height" class="textbox Height L">
                </div>
                <div class="container info3 border">
                    <div class="Black Box">GENDER</div>
                    <input type="text" name="attr_character_gender" class="textbox Gender L">
                    <div class="Black Box">WEIGHT</div>
                    <input type="number" name="attr_character_weight" class="textbox Weight L">
                </div>
                <div class="container info4 border">
                    <div class="Black Box">HP</div>
                    <div class="container">
                        <input type="hidden" name="attr_totalhp_bar" class="hidden HP_bar">
                        <div class="HP_bar">
                            <input type="number" name="attr_totalhp" class="Status_bar_left Status_bar">
                            <span class="Status_bar_center Status_center">/</span>
                            <input type="number" name="attr_totalhp_max" class="Status_bar_right Status_bar" readonly>
                        </div>
                    </div>
                    <div class="Black Box">MONEY</div>
                    <input type="number" name="attr_character_money" class="textbox Money L">
                </div>
            </div>
            <div class="item container apearance ">
                <div class="item Black Box">APPEARANCE</div>
                <div class="item container apearance1">
                    <textarea class="borderall C" name="attr_char_appearance" placeholder="Unique features?"></textarea>
                </div>
            </div>
            <div class="item container speed">
                <div class="container speed1">
                    <div class="Black Box item">INITIATIVE</div>
                    <button type="roll" name="roll_ini" value="!power {{ --charid|@{character_id}  --emote|@{character_name} --format|encounter --name|Инициатива --Roll|[[ [XPND|NH|TRKR] 3d6-@{initiative_mod}]] }}"></button>
                </div>
                <div class="container speed2">
                    <input type="number" name="attr_ini" class="textbox item" readonly>
                </div>
                <div class="container speed3">
                    <div class="Black Box item">SPEED</div>
                </div>
                <div class="container speed4">
                    <input type="number" name="attr_speed" class="textbox item" readonly>
                </div>
            </div>
        </div>
        <div class="container Status">
            <div class="container 3col">
                <div class="Black Box StatusBarName">STAMINA</div>
                <div class="Black Box StatusBarName">PSI</div>
                <div class="Black Box StatusBarName">MANA</div>
            </div>
            <div class="container 3col StatusBars">
                <div class="container">
                    <input type="hidden" name="attr_totalst_bar" class="hidden ST_bar">
                    <div class="ST_bar bar">
                        <input type="number" name="attr_totalst" class="Status_bar_left Status_bar">
                        <span class="Status_bar_center Status_center">/</span>
                        <input type="number" name="attr_totalst_max" class="Status_bar_right Status_bar" readonly>
                    </div>
                </div>
                <div class="container">
                    <input type="hidden" name="attr_totalps_bar" class="hidden PS_bar">
                    <div class="PS_bar bar">
                        <input type="number" name="attr_totalps" class="Status_bar_left Status_bar">
                        <span class="Status_bar_center Status_center">/</span>
                        <input type="number" name="attr_totalps_max" class="Status_bar_right Status_bar" readonly>
                    </div>
                </div>
                <div class="container">
                    <input type="hidden" name="attr_totalmp_bar" class="hidden MP_bar">
                    <div class="MP_bar bar">
                        <input type="number" name="attr_totalmp" class="Status_bar_left Status_bar">
                        <span class="Status_bar_center Status_center">/</span>
                        <input type="number" name="attr_totalmp_max" class="Status_bar_right Status_bar" readonly>
                    </div>
                </div>
            </div>
        </div>
        <div class="container StatusPoints border">
            <div class="container 3col">
                <div class="Black Box">BODY</div>
                <div class="Black Box">MIND</div>
                <div class="Black Box">SOUL</div>
            </div>
            <div class="container 3col">
                <input type="number" class="textbox C" name="attr_body">
                <input type="number" class="textbox C" name="attr_mind">
                <input type="number" class="textbox C" name="attr_soul">
            </div>
        </div>
        <div class="container Stats">
            <div class="container stats">
                <div class="container border">
                    <div class="container 3colStats">
                        <div class="White Box border">SCORE</div>
                        <div class="Black Box">ATTRIBUTE</div>
                        <div class="White Box border">MOD</div>
                        <div class="Black Box border">XP</div>
                    </div>
                    <div class="container 3colStats">
                        <div class="container  border WhiteBorder">
                            <input type="number" class="textbox border WhiteBorder" name="attr_str">
                        </div>
                        <div class="Black Box container WhiteBorder">
                            <button type="roll" class="AttrRoll" name="roll_str_check" value="!power {{
                                --charid|@{character_id}
                                --emote|@{character_name} Проверяет себя!
                                --template|check|Сила;?{Вариант проверки|1d20+mod,0|3d6 vs score,1};@{str};@{str_mod}
                                }}
                                \n!modattr --silent --charid @{character_id} --str_xp|+1">
                                <span class="StatName">Strength</span><br>
                            </button>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="number" class="textbox border WhiteBorder" name="attr_str_mod" step="0.5" readonly>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="hidden" class="hidden textbox border" name="attr_str_xp" readonly>
                            <input type="hidden" name="attr_str_xp_bar" class="xp_bar">
                            <div class="xp_bar bar vertical"></div>
                        </div>
                    </div>
                    <div class="container 3colStats">
                        <div class="container border WhiteBorder">
                            <input type="number" class="textbox border WhiteBorder" name="attr_dex">
                        </div>
                        <div class="Black Box container WhiteBorder">
                            <button type="roll" class="AttrRoll" name="roll_dex_check" value="!power {{
                                --charid|@{character_id}
                                --emote|@{character_name} Проверяет себя!
                                --template|check|Ловкость;?{Вариант проверки|1d20+mod,0|3d6 vs score,1};@{dex};@{dex_mod}
                                }}
                                \n!modattr --silent --charid @{character_id} --dex_xp|+1">
                                <span class="StatName">Dexterity</span><br>
                            </button>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="number" class="textbox" name="attr_dex_mod" step="0.5" readonly>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="hidden" class="hidden textbox border" name="attr_dex_xp" readonly>
                            <input type="hidden" name="attr_dex_xp_bar" class="xp_bar">
                            <div class="xp_bar bar vertical"></div>
                        </div>
                    </div>
                    <div class="container 3colStats">
                        <div class="container border WhiteBorder">
                            <input type="number" class="textbox border WhiteBorder" name="attr_con">
                        </div>
                        <div class="Black Box container WhiteBorder">
                            <button type="roll" class="AttrRoll" name="roll_con_check" value="!power {{
                                --charid|@{character_id}
                                --emote|@{character_name} Проверяет себя!
                                --template|check|Телосложение;?{Вариант проверки|1d20+mod,0|3d6 vs score,1};@{con};@{con_mod}
                                }}
                                \n!modattr --silent --charid @{character_id} --con_xp|+1">
                                <span class="StatName">Constitution</span><br>
                            </button>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="number" class="textbox" name="attr_con_mod" step="0.5" readonly>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="hidden" class="hidden textbox border" name="attr_con_xp">
                            <input type="hidden" name="attr_con_xp_bar" class="xp_bar">
                            <div class="xp_bar bar vertical"></div>
                        </div>
                    </div>
                    <div class="container 3colStats">
                        <div class="container border WhiteBorder">
                            <input type="number" class="textbox border WhiteBorder" name="attr_end">
                        </div>
                        <div class="Black Box container WhiteBorder">
                            <button type="roll" class="AttrRoll" name="roll_end_check" value="!power {{
                                --charid|@{character_id}
                                --emote|@{character_name} Проверяет себя!
                                --template|check|Выносливость;?{Вариант проверки|1d20+mod,0|3d6 vs score,1};@{end};@{end_mod}
                                }}
                                \n!modattr --silent --charid @{character_id} --end_xp|+1">
                                <span class="StatName">Endurance</span><br></button>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="number" class="textbox" name="attr_end_mod" step="0.5" readonly>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="hidden" class="hidden textbox border" name="attr_end_xp">
                            <input type="hidden" name="attr_end_xp_bar" class="xp_bar">
                            <div class="xp_bar bar vertical"></div>
                        </div>
                    </div>
                </div>
                <div class="container">
                </div>
                <div class="container border">
                    <div class="container 3colStats">
                        <div class="White Box border">SCORE</div>
                        <div class="Black Box">ATTRIBUTE</div>
                        <div class="White Box border">MOD</div>
                        <div class="Black Box border">XP</div>
                    </div>
                    <div class="container 3colStats">
                        <div class="container  border WhiteBorder">
                            <input type="number" class="textbox border WhiteBorder" name="attr_int">
                        </div>
                        <div class="Black Box container WhiteBorder roll">
                            <button type="roll" class="AttrRoll" name="roll_int_check" value="!power {{
                                --charid|@{character_id}
                                --emote|@{character_name} Проверяет себя!
                                --template|check|Интеллект;?{Вариант проверки|1d20+mod,0|3d6 vs score,1};@{int};@{int_mod}
                                }}
                                \n!modattr --silent --charid @{character_id} --int_xp|+1">
                                <span class="StatName">Intelligence</span><br>
                            </button>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="number" class="textbox border WhiteBorder" name="attr_int_mod" step="0.5" readonly>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="hidden" class="hidden textbox border" name="attr_int_xp" readonly>
                            <input type="hidden" name="attr_int_xp_bar" class="xp_bar">
                            <div class="xp_bar bar vertical"></div>
                        </div>
                    </div>
                    <div class="container 3colStats">
                        <div class="container border WhiteBorder">
                            <input type="number" class="textbox border WhiteBorder" name="attr_wis">
                        </div>
                        <div class="Black Box container WhiteBorder">
                            <button type="roll" class="AttrRoll" name="roll_wis_check" value="!power {{
                                --charid|@{character_id}
                                --emote|@{character_name} Проверяет себя!
                                --template|check|Мудрость;?{Вариант проверки|1d20+mod,0|3d6 vs score,1};@{wis};@{wis_mod}
                                }}
                                \n!modattr --silent --charid @{character_id} --wis_xp|+1">
                                <span class="StatName">Widsom</span><br>
                            </button>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="number" class="textbox" name="attr_wis_mod" step="0.5" readonly>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="hidden" class="hidden textbox border" name="attr_wis_xp" readonly>
                            <input type="hidden" name="attr_wis_xp_bar" class="xp_bar">
                            <div class="xp_bar bar vertical"></div>
                        </div>
                    </div>
                    <div class="container 3colStats">
                        <div class="container border WhiteBorder">
                            <input type="number" class="textbox border WhiteBorder" name="attr_will">
                        </div>
                        <div class="Black Box container WhiteBorder">
                            <button type="roll" class="AttrRoll" name="roll_will_check" value="!power {{
                                --charid|@{character_id}
                                --emote|@{character_name} Проверяет себя!
                                --template|check|Воля;?{Вариант проверки|1d20+mod,0|3d6 vs score,1};@{will};@{will_mod}
                                }}
                                \n!modattr --silent --charid @{character_id} --will_xp|+1">
                                <span class="StatName">Will</span><br></button>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="number" class="textbox" name="attr_will_mod" step="0.5" readonly>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="hidden" class="hidden textbox border" name="attr_will_xp">
                            <input type="hidden" name="attr_will_xp_bar" class="xp_bar">
                            <div class="xp_bar bar vertical"></div>
                        </div>
                    </div>
                    <div class="container 3colStats">
                        <div class="container border WhiteBorder">
                            <input type="number" class="textbox border WhiteBorder" name="attr_cun">
                        </div>
                        <div class="Black Box container WhiteBorder">
                            <button type="roll" class="AttrRoll" name="roll_cun_check" value="!power {{
                                --charid|@{character_id}
                                --emote|@{character_name} Проверяет себя!
                                --template|check|Хитрость;?{Вариант проверки|1d20+mod,0|3d6 vs score,1};@{cun};@{cun_mod}
                                }}
                                \n!modattr --silent --charid @{character_id} --cun_xp|+1">
                                <span class="StatName">Cunning</span><br></button>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="number" class="textbox" name="attr_cun_mod" step="0.5" readonly>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="hidden" class="hidden textbox border" name="attr_cun_xp">
                            <input type="hidden" name="attr_cun_xp_bar" class="xp_bar">
                            <div class="xp_bar bar vertical"></div>
                        </div>
                    </div>
                </div>
                <div class="container"></div>
                <div class="container border">
                    <div class="container 3colStats">
                        <div class="White Box border">SCORE</div>
                        <div class="Black Box">ATTRIBUTE</div>
                        <div class="White Box border">MOD</div>
                        <div class="Black Box border">XP</div>
                    </div>
                    <div class="container 3colStats">
                        <div class="container  border WhiteBorder">
                            <input type="number" class="textbox border WhiteBorder" name="attr_per">
                        </div>
                        <div class="Black Box container WhiteBorder roll">
                            <button type="roll" class="AttrRoll" name="roll_per_check" value="!power {{
                                --charid|@{character_id}
                                --emote|@{character_name} Проверяет себя!
                                --template|check|Интеллект;?{Вариант проверки|1d20+mod,0|3d6 vs score,1};@{per};@{per_mod}
                                }}
                                \n!modattr --silent --charid @{character_id} --per_xp|+1">
                                <span class="StatName">Perception</span><br>
                            </button>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="number" class="textbox border WhiteBorder" name="attr_per_mod" step="0.5" readonly>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="hidden" class="hidden textbox border" name="attr_per_xp" readonly>
                            <input type="hidden" name="attr_per_xp_bar" class="xp_bar">
                            <div class="xp_bar bar vertical"></div>
                        </div>
                    </div>
                    <div class="container 3colStats">
                        <div class="container border WhiteBorder">
                            <input type="number" class="textbox border WhiteBorder" name="attr_cha">
                        </div>
                        <div class="Black Box container WhiteBorder">
                            <button type="roll" class="AttrRoll" name="roll_cha_check" value="!power {{
                                --charid|@{character_id}
                                --emote|@{character_name} Проверяет себя!
                                --template|check|Мудрость;?{Вариант проверки|1d20+mod,0|3d6 vs score,1};@{cha};@{cha_mod}
                                }}
                                \n!modattr --silent --charid @{character_id} --cha_xp|+1">
                                <span class="StatName">Charisma</span><br>
                            </button>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="number" class="textbox" name="attr_wis_mod" step="0.5" readonly>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="hidden" class="hidden textbox border" name="attr_cha_xp" readonly>
                            <input type="hidden" name="attr_cha_xp_bar" class="xp_bar">
                            <div class="xp_bar bar vertical"></div>
                        </div>
                    </div>
                    <div class="container 3colStats">
                        <div class="container border WhiteBorder">
                            <input type="number" class="textbox border WhiteBorder" name="attr_luck">
                        </div>
                        <div class="Black Box container WhiteBorder">
                            <button type="roll" class="AttrRoll" name="roll_luck_check" value="!power {{
                                --charid|@{character_id}
                                --emote|@{character_name} Проверяет себя!
                                --template|check|Воля;?{Вариант проверки|1d20+mod,0|3d6 vs score,1};@{luck};@{luck_mod}
                                }}
                                \n!modattr --silent --charid @{character_id} --luck_xp|+1">
                                <span class="StatName">Luck</span><br></button>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="number" class="textbox" name="attr_luck_mod" step="0.5" readonly>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="hidden" class="hidden textbox border" name="attr_luck_xp">
                            <input type="hidden" name="attr_luck_xp_bar" class="xp_bar">
                            <div class="xp_bar bar vertical"></div>
                        </div>  
                    </div>
                    <div class="container 3colStats">
                        <div class="container border WhiteBorder">
                            <input type="number" class="textbox border WhiteBorder" name="attr_ada">
                        </div>
                        <div class="Black Box container WhiteBorder">
                            <button type="roll" class="AttrRoll" name="roll_ada_check" value="!power {{
                                --charid|@{character_id}
                                --emote|@{character_name} Проверяет себя!
                                --template|check|Хитрость;?{Вариант проверки|1d20+mod,0|3d6 vs score,1};@{ada};@{ada_mod}
                                }}
                                \n!modattr --silent --charid @{character_id} --ada_xp|+1">
                                <span class="StatName">Adaptability</span><br></button>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="number" class="textbox" name="attr_ada_mod" step="0.5" readonly>
                        </div>
                        <div class="container border WhiteBorder">
                            <input type="hidden" class="hidden textbox border" name="attr_ada_xp">
                            <input type="hidden" name="attr_ada_xp_bar" class="xp_bar">
                            <div class="xp_bar bar vertical"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container Attacks border">
            <div class="container attackHeader">
                <div class="Black Box">NAME</div>
                <div class="Black Box">ROLL</div>
                <div class="Black Box">RANGE</div>
                <div class="Black Box">EFFECT</div>
            </div>
            <div class="container Attack">
                <div class="container AttackHead">
                    <input type="text" name="attr_Attack_name">
                    <button type="roll" class="AttackRoll" name="roll_Attack_check" value=""></button>
                    <input type="text" name="attr_Attack_name">
                    <input type="text" name="attr_Attack_name">
                </div>
            </div>
        </div>
    </div>
    <div class="tab_content tab2 container">
        tab2
    </div>
    <div class="tab_content tab3 container">
        tab3
    </div>
    <div class="tab_content tab4 container">
        tab4
    </div>
    <div class="tab_content tab5 container">
        tab5
    </div>
</div>

<script type="text/worker">
         

    on("change:int change:will change:cun change:end change:ada change:per", function() {
        getAttrs(["int","will","cun","end","ada","per"], function(values) {
            var int = parseFloat(values.int, 10)||0;
            var will = parseFloat(values.will, 10)||0;
            var cun = parseFloat(values.cun, 10)||0;
            var end = parseFloat(values.end, 10)||0;
            var ada = parseFloat(values.ada, 10)||0;
            var per = parseFloat(values.per, 10)||0;
            var out = Math.floor( will*1.75 + cun*1.5 + ada*1.375 + int*1.25 + per + end*0.25 );
            setAttrs({
                totalps_max: out
            });
        });
    });

    on("change:end change:str change:con change:will change:ada", function() {
        getAttrs(["end","str","con", "will", "ada"], function(values) {
            var end = parseFloat(values.end, 10)||0;
            var str = parseFloat(values.str, 10)||0;
            var con = parseFloat(values.con, 10)||0;
            var will = parseFloat(values.will, 10)||0;
            var ada = parseFloat(values.ada, 10)||0;
            var out = Math.floor( (end*1.3 + con*0.55 + str*0.55)*5 + ada*2 + will*1.5 );
            setAttrs({
                totalst_max: out
            });
        });
    });

    on("change:end change:ada change:will", function() {
        getAttrs(["will","end","ada"], function(values) {
            var will = parseFloat(values.will, 10)||0;
            var end = parseFloat(values.end, 10)||0;
            var ada = parseFloat(values.ada, 10)||0;
            var out = Math.floor(end + ada*2.5 + will*5);
            setAttrs({
                totalmp_max: out
            });
        });
    });

    on("change:con", function() {
        getAttrs(["con"], function(values) {
            var attr = parseFloat(values.con, 10)||0;
            var out = attr*2;
            if (attr >= 100) {
                out = Math.floor(attr*4*5);
            } else if (attr >= 75) {
                out = Math.floor(attr*3.7*5);
            } else if (attr >= 50) {
                out = Math.floor(attr*3.51*5);
            } else if (attr >= 25) {
                out = Math.floor(attr*3.33*5);
            } else if (attr >= 10) {
                out = Math.floor(attr*3.16*5);
            } else {
                out = Math.floor(attr*3*5);
            }
            console.log("HP is set to "+out);
            setAttrs({
                totalhp_max: out
            });
        });
    });

    const bars = ['totalhp','totalst','totalmp','totalps'];
    bars.forEach(function (bar) {
        on("change:"+ bar, function() {
            getAttrs([bar, bar+"_max"], function(values) {
                var current = parseFloat(values[bar], 10)||0;
                var max = parseFloat(values[bar+'_max'], 10)||100;
                var out = Math.floor(current / max * 100)
                setAttrs({
                    [bar+'_bar']: out
                });
            });
        });
    });

    const stats = ['str', 'dex', 'con', 'end', 'int', 'wis', 'will', 'cun', 'per', 'cha', 'luck', 'ada'];
    stats.forEach(function (stat) {
        on("change:"+ stat+"_xp"   , function() {
            getAttrs([stat, stat+"_xp", stat+"_xp_max"], function(values) {
                var attr= parseInt(values[stat], 10)||10;
                var xp = parseInt(values[stat+'_xp'], 10)||0;
                var lvlup = parseInt(values[stat+'_xp_max'], 10)|| 10;
                var out = Math.floor((xp/lvlup)*100)||0;
                if (xp >= lvlup) {
                    console.log("increasing "+stat+" by 1");
                    setAttrs({
                        [stat]: (attr+1),
                        [stat+'_xp']: (xp-lvlup)
                    });
                } else {
                    console.log("Updating "+stat+" xp bar to "+out+"%");
                    setAttrs({
                        [stat+'_xp_bar']: out
                    });
                }
            });
        });
    });
    stats.forEach(function (stat) {
        on("change:"+ stat , function() {
            getAttrs([stat, stat+'_xp'], function(values) {
                var attr= parseInt(values[stat], 10)||10;
                var xp = parseInt(values[stat+'_xp'], 10)||0;
                var newMod = (attr-10)/2;
                var NewXp = Math.floor(attr*(1+attr)*0.91);
                var NewBar = Math.floor((xp/NewXp)*100);
                console.log(stat+" is updated! increasing mod to "+newMod+" lvlUp to "+NewXp+" xp bar to "+NewBar+"%");
                setAttrs({ 
                    [stat+'_mod']: newMod,
                    [stat+'_xp_max']: NewXp,
                    [stat+'_xp_bar']: NewBar
                });
            });
        });
    });
</script>
